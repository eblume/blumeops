---
id: 1768506761-XGYX
tags:
- blumeops
---

# Loki Management Log

Loki is a log aggregation system running in Kubernetes (minikube on indri), providing log storage and querying for the [[1767747119-YCPO|blumeops]] infrastructure.

## Service Details

- URL: https://loki.tail8d86e.ts.net
- Namespace: `monitoring`
- Image: `grafana/loki:3.4.2`
- ArgoCD app: `loki`
- Storage: 50Gi PVC
- Retention: 31 days

## Architecture

- Single-node deployment with filesystem storage
- TSDB index with 24h period
- Logs collected by [[alloy|Grafana Alloy]] and pushed via Loki API
- Queried via Grafana using the Loki datasource

## Useful Commands

```bash
# View logs
kubectl --context=minikube-indri -n monitoring logs -f loki-0

# Check if Loki is ready
curl -s https://loki.tail8d86e.ts.net/ready

# Sync from ArgoCD
argocd app sync loki
```

## Grafana Integration

Loki is configured as a datasource in Grafana. To explore logs:

1. Go to https://grafana.tail8d86e.ts.net/explore
2. Select "Loki" datasource
3. Use LogQL queries:
   - `{service="forgejo"}` - all forgejo logs
   - `{service="borgmatic", stream="stderr"}` - borgmatic errors
   - `{host="indri"} |= "error"` - all logs containing "error"

## ArgoCD Management

Loki is deployed via ArgoCD from `argocd/manifests/loki/`:
- `statefulset.yaml` - StatefulSet with 50Gi PVC
- `configmap.yaml` - Loki configuration
- `service.yaml` - ClusterIP service
- `ingress-tailscale.yaml` - Tailscale Ingress

## Log

### Thu Jan 23 2026

- Suppressed noisy `v1 Endpoints is deprecated` warning from minikube storage-provisioner ([upstream issue](https://github.com/kubernetes/minikube/issues/21009))
- Added JSON field extraction for zot compatibility (`message` vs `msg`)
- Removed logfmt parsing stage - `stage.match` selectors don't prevent Alloy from logging internal decode errors, and most structured logs use JSON anyway
- Fixed devpi dashboard JSON escaping

### Wed Jan 22 2026

- **Migrated to Kubernetes** - moved from Homebrew on indri to k8s StatefulSet
- Exposed via Tailscale Ingress at `loki.tail8d86e.ts.net`
- Alloy updated to push logs to k8s endpoint
- Retired ansible loki role from indri

### Wed Jan 15 2026

- Initial setup with single-node filesystem storage
- Configured 31-day retention with compactor
- Integrated with Grafana as datasource
- Logs collected via Alloy from all services
