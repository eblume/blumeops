#!/usr/bin/env bash
#MISE description="List available containers and their recent tags"

set -euo pipefail

REGISTRY="registry.ops.eblu.me"
CONTAINER_DIR="containers"

echo "Container Images"
echo "================"
echo ""

# Find all container directories with Dockerfiles or default.nix
for dir in "$CONTAINER_DIR"/*/; do
    [[ -d "$dir" ]] || continue

    # Determine build type
    if [[ -f "$dir/default.nix" ]]; then
        build_type="nix"
    elif [[ -f "$dir/Dockerfile" ]]; then
        build_type="dockerfile"
    else
        continue
    fi

    # Extract container name from directory
    container=$(basename "$dir")
    image="blumeops/$container"

    echo "[$build_type] $container"
    echo "   Image: $REGISTRY/$image"
    echo "   Path: $dir"

    # Query zot for recent tags
    tags=$(curl -sf "https://$REGISTRY/v2/$image/tags/list" 2>/dev/null | jq -r '.tags // [] | .[]' | grep -E '^v[0-9]' | sort -V | tail -4 || true)

    if [[ -n "$tags" ]]; then
        echo "   Recent tags:"
        echo "$tags" | while read -r tag; do
            echo "     - $tag"
        done
    else
        echo "   Recent tags: (none)"
    fi
    echo ""
done

echo "---"
echo "To release a new version:"
echo "  mise run container-tag-and-release <container> <version>"
echo ""
echo "Example:"
echo "  mise run container-tag-and-release nettest v1.0.0"
