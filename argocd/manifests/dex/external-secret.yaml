---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: dex-config
  namespace: dex
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword-blumeops
  target:
    name: dex-config
    creationPolicy: Owner
    template:
      data:
        config.yaml: |
          issuer: https://dex.ops.eblu.me
          storage:
            type: kubernetes
            config:
              inCluster: true
          web:
            http: 0.0.0.0:5556
          oauth2:
            skipApprovalScreen: true
          enablePasswordDB: true
          staticPasswords:
            - email: "blume.erich@gmail.com"
              hash: "{{ .staticPasswordHash }}"
              username: "eblume"
              userID: "eblume-001"
          staticClients:
            - id: grafana
              name: Grafana
              secret: "{{ .grafanaClientSecret }}"
              redirectURIs:
                - "https://grafana.ops.eblu.me/login/generic_oauth"
                - "https://grafana.tail8d86e.ts.net/login/generic_oauth"
  data:
    - secretKey: staticPasswordHash
      remoteRef:
        key: "Dex (blumeops)"
        property: static-password-hash
    - secretKey: grafanaClientSecret
      remoteRef:
        key: "Dex (blumeops)"
        property: grafana-client-secret
