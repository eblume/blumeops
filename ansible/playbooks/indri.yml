---
- name: Configure indri
  hosts: indri

  # Fetch 1Password credentials upfront to minimize prompts
  # Each role also fetches its own credentials (with 'when: <var> is not defined')
  # so they still work when running with --tags
  pre_tasks:
    - name: Fetch borgmatic database password
      ansible.builtin.command:
        cmd: op --vault vg6xf6vvfmoh5hqjjhlhbeoaie item get mw2bv5we7woicjza7hc6s44yvy --fields db-password --reveal
      delegate_to: localhost
      register: _borgmatic_db_pw
      changed_when: false
      no_log: true
      check_mode: false
      tags: [borgmatic]

    - name: Set borgmatic database password fact
      ansible.builtin.set_fact:
        borgmatic_db_password: "{{ _borgmatic_db_pw.stdout }}"
      no_log: true
      tags: [borgmatic]

  roles:
    - role: loki
      tags: loki
    - role: alloy
      tags: alloy
    - role: prometheus
      tags: prometheus
    # NOTE: grafana role removed - now hosted in k8s (see argocd/apps/grafana.yaml)
    - role: transmission
      tags: transmission
    - role: transmission_metrics
      tags: transmission_metrics
    - role: kiwix
      tags: kiwix
    - role: borgmatic
      tags: borgmatic
    - role: borgmatic_metrics
      tags: borgmatic_metrics
    - role: forgejo
      tags: forgejo
    - role: devpi
      tags: devpi
    - role: devpi_metrics
      tags: devpi_metrics
    - role: zot
      tags: zot
    - role: zot_metrics
      tags: zot_metrics
    - role: podman
      tags: podman
    - role: minikube
      tags: minikube
    - role: minikube_metrics
      tags: minikube_metrics
    - role: plex_metrics
      tags: plex_metrics
    # NOTE: postgresql and miniflux roles removed - now hosted in k8s
    - role: tailscale_serve
      tags: tailscale-serve
