---
- name: Ensure kiwix ZIM directory exists
  ansible.builtin.file:
    path: "{{ kiwix_zim_dir }}"
    state: directory
    mode: '0755'

- name: Ensure kiwix bin directory exists
  ansible.builtin.file:
    path: "{{ kiwix_bin_dir }}"
    state: directory
    mode: '0755'

# --- Deploy management scripts ---
- name: Deploy kiwix torrent sync script
  ansible.builtin.template:
    src: kiwix-sync-torrents.sh.j2
    dest: "{{ kiwix_bin_dir }}/kiwix-sync-torrents.sh"
    mode: '0755'
  when: kiwix_use_transmission

- name: Deploy kiwix symlink script
  ansible.builtin.template:
    src: kiwix-symlink-zims.sh.j2
    dest: "{{ kiwix_bin_dir }}/kiwix-symlink-zims.sh"
    mode: '0755'
  when: kiwix_use_transmission

- name: Deploy kiwix torrent list
  ansible.builtin.template:
    src: kiwix-torrents.txt.j2
    dest: "{{ kiwix_bin_dir }}/kiwix-torrents.txt"
    mode: '0644'
  when: kiwix_use_transmission

# --- Transmission-based torrent management ---
- name: Check transmission daemon is responding
  ansible.builtin.command: transmission-remote -l
  register: kiwix_transmission_check
  changed_when: false
  failed_when: false
  when: kiwix_use_transmission

- name: Fail if transmission is not running
  ansible.builtin.fail:
    msg: "Transmission daemon is not responding. Ensure transmission role ran successfully."
  when: kiwix_use_transmission and kiwix_transmission_check.rc != 0

- name: Sync ZIM torrents to transmission
  ansible.builtin.command: "{{ kiwix_bin_dir }}/kiwix-sync-torrents.sh {{ kiwix_bin_dir }}/kiwix-torrents.txt"
  register: kiwix_torrent_sync
  changed_when: "'Added:' in kiwix_torrent_sync.stdout"
  when: kiwix_use_transmission

# --- Symlink completed ZIM files ---
- name: Symlink completed ZIM files to kiwix directory
  ansible.builtin.command: "{{ kiwix_bin_dir }}/kiwix-symlink-zims.sh {{ transmission_download_dir }} {{ kiwix_zim_dir }}"
  register: kiwix_symlink_result
  changed_when: "'Linked:' in kiwix_symlink_result.stdout"
  when: kiwix_use_transmission
  notify: Restart kiwix-serve

# --- Fallback: Direct HTTP download (original behavior) ---
- name: Check which ZIM archives exist (direct download mode)
  ansible.builtin.stat:
    path: "{{ kiwix_zim_dir }}/{{ item.filename }}"
    get_checksum: false
  loop: "{{ kiwix_zim_archives }}"
  loop_control:
    label: "{{ item.filename }}"
  register: kiwix_zim_stat
  when: not kiwix_use_transmission

- name: Download missing ZIM archives (direct download mode)
  ansible.builtin.get_url:
    url: "https://download.kiwix.org/zim/{{ item.item.category }}/{{ item.item.filename }}"
    dest: "{{ kiwix_zim_dir }}/{{ item.item.filename }}"
    mode: '0644'
    timeout: 3600
  loop: "{{ kiwix_zim_stat.results | default([]) }}"
  loop_control:
    label: "{{ item.item.filename | default('unknown') }}"
  when:
    - not kiwix_use_transmission
    - item.stat is defined
    - not item.stat.exists
  notify: Restart kiwix-serve

# --- Determine which archives are available ---
- name: Find available ZIM archives in kiwix directory
  ansible.builtin.find:
    paths: "{{ kiwix_zim_dir }}"
    patterns: "*.zim"
    file_type: any  # includes symlinks
  register: kiwix_available_zim_files

- name: Build list of available archive filenames
  ansible.builtin.set_fact:
    kiwix_available_archives: "{{ kiwix_available_zim_files.files | map(attribute='path') | map('basename') | list }}"

# --- LaunchAgent deployment ---
- name: Deploy kiwix-serve LaunchAgent plist
  ansible.builtin.template:
    src: kiwix-serve.plist.j2
    dest: ~/Library/LaunchAgents/mcquack.eblume.kiwix-serve.plist
    mode: '0644'
  notify: Restart kiwix-serve

- name: Check if kiwix-serve LaunchAgent is loaded
  ansible.builtin.command: launchctl list mcquack.eblume.kiwix-serve
  register: kiwix_launchctl_check
  changed_when: false
  failed_when: false

- name: Load kiwix-serve LaunchAgent if not loaded
  ansible.builtin.command: launchctl load ~/Library/LaunchAgents/mcquack.eblume.kiwix-serve.plist
  when: kiwix_launchctl_check.rc != 0
  changed_when: true
  failed_when: false
