---
# Loki installation and configuration

- name: Install loki via homebrew
  community.general.homebrew:
    name: loki
    state: present

- name: Ensure loki data directory exists
  ansible.builtin.file:
    path: "{{ loki_data_dir }}"
    state: directory
    mode: '0755'

- name: Ensure loki chunks directory exists
  ansible.builtin.file:
    path: "{{ loki_data_dir }}/chunks"
    state: directory
    mode: '0755'

- name: Ensure loki rules directory exists
  ansible.builtin.file:
    path: "{{ loki_data_dir }}/rules"
    state: directory
    mode: '0755'

- name: Deploy loki configuration
  ansible.builtin.template:
    src: loki-config.yaml.j2
    dest: "{{ loki_config_file }}"
    mode: '0644'
  notify: restart loki

- name: Ensure loki service is started
  ansible.builtin.command: brew services start loki
  register: brew_start
  changed_when: "'Successfully started' in brew_start.stdout"
  failed_when: false
