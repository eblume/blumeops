---
# Forgejo role
#
# Currently uses brew-managed forgejo. Phase 3 of ci-cd-bootstrap will
# transition to mcquack LaunchAgent with CI-built binary.
#
# Secrets (lfs_jwt_secret, internal_token, oauth2_jwt_secret) are fetched
# from 1Password in the playbook pre_tasks.

- name: Install forgejo via homebrew
  community.general.homebrew:
    name: forgejo
    state: present

- name: Ensure forgejo config directory exists
  ansible.builtin.file:
    path: "{{ forgejo_work_path }}/custom/conf"
    state: directory
    mode: '0755'

- name: Deploy forgejo config
  ansible.builtin.template:
    src: app.ini.j2
    dest: "{{ forgejo_config_path }}"
    mode: '0600'
  notify: Restart forgejo

- name: Ensure forgejo service is started
  ansible.builtin.command: brew services start forgejo
  register: forgejo_brew_start
  changed_when: "'Successfully started' in forgejo_brew_start.stdout"
  failed_when: false
